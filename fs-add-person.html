<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../fs-person-gender/fs-person-gender-selector.html">
<link rel="import" href="../fs-date/fs-date.html">
<link rel="import" href="../fs-place/fs-place.html">

<dom-module id="fs-add-person">
  <template>
    <style>
      :host {
        display: block;
      }
      
      .row {
        display: flex;
      }
      
      .name > paper-input {
        width: 100%;
      }
      
      .name > paper-input:last-child {
        margin-left: 16px;
      }
      
      .gender-living > div {
        flex: 1;
      }
      
      .gender paper-radio-button {
        display: block;
      }
      
      .vital fs-date {
        flex: 1;
      }
      
      .vital fs-place {
        flex: 2;
        margin-left: 16px;
      }
      
      #next-btn:not([disabled]) {
        background-color: var(--paper-blue-500);
        color: #fff;
      }
      
      #loader {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(230, 230, 230, .6);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        padding: 0;
      }
      
      [hidden] {
        display: none !important;
      }
    </style>
    <paper-dialog id="dialog" opened="{{opened}}" modal>
      <h2>Add A Person</h2>
      <div hidden="[[!_showDataStep(_step)]]">
        <div class="row name">
          <paper-input label="First Names" value="{{firstNames}}"></paper-input>
          <paper-input label="Last Names" value="{{lastNames}}"></paper-input>
        </div>
        <div class="row gender-living">
          <div class="gender">
            <div>Gender</div>
            <fs-person-gender-selector gender="{{gender}}"></fs-person-gender-selector>
          </div>
          <div>
            <div>Living</div>
            <paper-radio-group on-iron-select="_livingSelection">
              <paper-radio-button name="living">Living</paper-radio-button>
              <paper-radio-button name="deceased">Deceased</paper-radio-button>
            </paper-radio-group>
          </div>
        </div>
        <div class="row vital">
          <fs-date edit date="{{birthDate}}" label="Birth Date"></fs-date>
          <fs-place edit place="{{birthPlace}}" label="Birth Place"></fs-place>
        </div>
        <div class="row vital">
          <fs-date edit disabled="{{_deathDisabled}}" date="{{deathDate}}" label="Death Date"></fs-date>
          <fs-place edit disabled="{{_deathDisabled}}" place="{{deathPlace}}" label="Death Place"></fs-place>
        </div>
      </div>
      <div hidden="[[!_showResultsStep(_step)]]">
        <p>Results</p>
      </div>
      <div class="buttons">
        <paper-button on-tap="close">Cancel</paper-button>
        <paper-button id="next-btn" 
          raised disabled="[[!_searchReady]]"
          hidden="[[!_showDataStep(_step)]]"
          on-tap="_search">Next</paper-button>
      </div>
      <div id="loader" hidden="[[!_loading]]">
        <paper-spinner-lite active class="blue"></paper-spinner-lite>
      </div>
    </paper-dialog>
    <fs-request 
      id="request"
      loading="{{_loading}}"
      headers='{"Accept":"application/x-gedcomx-atom+json"}'
      on-response="_handleSearchResponse"></fs-request>
  </template>

  <script>
    /**
     * `fs-add-person`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class FsAddPerson extends Polymer.Element {
      static get is() { return 'fs-add-person'; }
      static get properties() {
        return {
          opened: {
            type: Boolean,
            value: false
          },
          
          /** 
           * Do these need to be public? Do we want to allow these value to
           * be set and read?
           */
          firstNames: String,
          lastNames: String,
          gender: String,
          living: Boolean,
          birthDate: Object,
          birthPlace: Object,
          deathDate: Object,
          deathPlace: Object,
          
          /** Whether the search request is loading */
          _loading: Boolean,
          
          /** Whether the death inputs should be disabled */
          _deathDisabled: {
            type: Boolean,
            value: true,
            computed: '_disableDeath(living)'
          },
          
          /** Whether we have enough data to search for duplicates */
          _searchReady: {
            type: Boolean,
            value: false,
            computed: '_readyToSearch(firstNames, lastNames, gender, living)'
          },
          
          /** Which step or page we are on */
          _step: {
            type: String,
            value: 'data'
          }
        };
      }
      
      open() {
        this.opened = true;
      }
      
      close() {
        this.opened = false;
      }
      
      /**
       * Issue the API request for finding possible duplicates
       */
      _search() {
        this.$.request.url = this._calculateSearchUrl();
        this.$.request.generateRequest();
      }
      
      /**
       * Calculate the URL for searching for matches. The matches query API
       * requires a lot of data so if we don't have enough then we'll use the
       * regular search API.
       */
      _calculateSearchUrl() {
        const queryParts = {};
        if(this.firstNames) {
          queryParts.givenName = this.firstNames;
        }
        if(this.lastNames) {
          queryParts.surname = this.lastNames;
        }
        switch(this.gender) {
          case 'http://gedcomx.org/Male':
            queryParts.gender = 'male';
            break;
          case 'http://gedcomx.org/Female':
            queryParts.gender = 'female';
            break;
        }
        if(this.birthDate) {
          queryParts.birthDate = this.birthDate.original;
        }
        if(this.birthPlace) {
          queryParts.birthPlace = this.birthPlace.original;
        }
        if(this.deathDate) {
          queryParts.deathDate = this.deathDate.original;
        }
        if(this.deathPlace) {
          queryParts.deathPlace = this.deathPlace.original;
        }
        const query = Object.keys(queryParts)
          .map((key) => `${key}:"${queryParts[key]}"`)
          .join(' ');
        const match = this.firstNames && this.lastNames && this.gender && this.living !== undefined
          && this.birthDate && this.deathDate && this.deathPlace;
        return `/platform/tree/${match ? 'match' : 'search'}?q=${query}`;
      }
      
      _handleSearchResponse(e) {
        const response = e.detail.response;
        // Process results
        this._step = 'results';
      }
      
      /**
       * We use this event listener to calculate the value of living,
       * as opposed to just doing two-way binding, because paper-radio-group
       * doesn't support boolean values so we have to calculate the
       * value ourself.
       */
      _livingSelection(e) {
        this.living = e.detail.item.name === 'living';
      }
      
      /**
       * Disable death date and place when the person is not marked as deceased.
       */
      _disableDeath(living) {
        return living !== false;
      }
      
      /**
       * Calculate whether we have enough information to proceed to the search step.
       */
      _readyToSearch(firstNames, lastNames, gender, living) {
        return (firstNames || lastNames) && gender && living !== undefined;
      }
      
      /**
       * Whether to show the data step
       */
      _showDataStep(_step) {
        return _step === 'data';
      }
      
      /**
       * Whether to show the results step
       */
      _showResultsStep(_step) {
        return _step === 'results';
      }
    }

    window.customElements.define(FsAddPerson.is, FsAddPerson);
  </script>
</dom-module>
